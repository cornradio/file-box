<!DOCTYPE html>
<html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta charset="UTF-8">

    <!-- emoji icon -->
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ“¦</text></svg>"
        type="image/x-icon">
    <title>box1</title>
    <style>
        /* media */
        @media (max-width: 600px) {
            .item1 {
                width: 100% !important;
                max-width: none !important;
                min-width: none !important;

                min-height: 80vh !important;

                margin: 40px 0;
            }

            .file-actions button:last-child {
                margin-right: 10px !important;
            }

        }
    </style>
    <style>
        /* main style */
        body {
            margin: 0;
            padding: 0;
            background-color: #262626;
            color: #666;
        }

        .item1 {
            /* margin: 0 10px; */
            min-height: 100vh;
            min-width: 380px;
            max-width: 30%;
            box-shadow: 0 0 10px rgb(0, 0, 0);
        }


        .filelist {
            /* overflow-y: scroll; */
            background-color: #0000002d;

        }

        .file {
            display: flex;
            align-items: center;
            flex-wrap: nowrap;
            vertical-align: middle;
            /* box-shadow:inset 0px -10px 2px rgba(109, 109, 109, 0.062),
            inset 0px 16px 2px rgba(255, 255, 255, 0.59); */
            /* overflow: hidden; */
            border-bottom: 1px solid rgb(0 0 0 / 50%);
            height: 1.6em;
            color: rgb(212, 212, 212);
            padding: 0 5px 0 5px;
        }

        .file-name {
            text-wrap: nowrap;
            display: inline-block;
        }

        .file:hover {
            background-color: #07845e2f !important;
            color: rgba(164, 229, 23, 0.696);
        }

        .file-actions {
            margin-left: auto;
        }

        .file:nth-child(even) {
            background-color: #00000012;
        }

        button:hover {
            transform: scale(1.2);
        }

        button:active {
            transform: scale(0.9);
        }

        .file-actions button {
            background-color: transparent;
            border: none;
            width: 22px;
        }

        .file-actions button:last-child {
            margin-right: 1px;
        }


        /* .file-actions button:nth-child(1){
            background-color: greenyellow;
        }
        .file-actions button:nth-child(2){
            background-color: red;
            color: #fff;
        } */


        /* æ§åˆ¶å° æ“ä½œæŒ‰é’®ç­‰ */
        .panel {
            background-color: #1b1b1b;
            color: rgba(255, 255, 255, 0.307);
            padding: 0;
            margin: 0;
            padding-bottom: .5em;
            border: 0;
            overflow: hidden;
        }

        .panel button {
            float: right;
            background-color: transparent !important;
            color: rgb(0, 255, 213);
            min-width: 20%;
            border: none;

        }

        .panel input {
            padding-left: .7em;
            width: 70%;
            background: transparent;
            border: none;
            color: white;
        }

        .panel label {
            width: 70%;
            padding-left: .7em;
            font-size: small;
        }

        .panel h1 {
            margin: 0;
            line-height: 2em;
            margin-left: .2em;
            color: #ffffff;
            text-shadow: 0 0 1px black;
        }

        input[type="file"] {
            display: none;
        }
    </style>
    <style>
        /* toast */
        #toastContainer {
            position: fixed;
            bottom: 10px;
            left: 10px;
            z-index: 9999;
            transition: all 0.3s ease-in-out;
        }

        .toast {
            background-color: rgba(0, 0, 0, 0.438);
            backdrop-filter: blur(10px);
            color: #00ebd7;
            font-size: smaller;
            padding: 4px 8px;
            margin-bottom: 10px;
            opacity: 0;
            animation: float-in 0.3s ease-in-out;
            /* transition: 0.3s ease-in-out; */
        }

        .toast.dark-mode {
            background-color: #444;
            border: 1px solid #2d2d2d;
            color: #d8d8d8;
        }

        .toast.show {
            opacity: 0.8;
        }

        .toast.hide {
            animation: slide-out 0.5s ease-in-out;
        }

        @keyframes float-in {
            0% {
                transform: translateY(20px);
            }

            100% {
                transform: translateY(0);
            }
        }

        @keyframes slide-out {
            0% {
                transform: translateY(0);
            }

            100% {
                transform: translateY(-20px);
                opacity: 0;
            }
        }
    </style>
</head>

<body>

    <div class="grid-container">

        <div class="item item1">

            <div class="panel">
                <h1>ğŸ“¦ file-box</h1>
                <div class="fileinput">
                    <input id="file_lable" onclick="choosefile()" placeholder="choose_file" for="the_file"></input>
                    <input id="the_file" type="file" />
                    <button type="submit" onclick="uploadFile();refreshFilelist(false);">ğŸ“¤ Upload</button>
                </div>
                <!-- <input id="boxname" placeholder="box_name" />
                <button>ğŸ”€ Switch</button> -->
                <!-- <input id="filesearch" placeholder="keyword" />
                <button>ğŸ” Search</button> -->
                <input id="filelist_info" placeholder="3_files" />
                <button onclick="checkcmd()">ğŸ”„ Reload</button>
            </div>

            <div class="filelist">
                <div class="file">
                    <span class="file-icon">ğŸ–¼ï¸</span>
                    <small class="file-name">image.png</small>
                    <span class="file-actions">
                        <button>ğŸ’¾</button>
                        <button>ğŸ—‘ï¸</button>
                    </span>
                </div>
            </div>
            <div id="toastContainer"></div>


        </div>
    </div>

</body>
<script>// Toast
    function showToast(textContent, darkMode) {
        var toast = document.createElement('div');// åˆ›å»ºToastå…ƒç´ 
        toast.classList.add('toast');
        toast.textContent = textContent;

        var container = document.getElementById('toastContainer');// å°†Toastæ·»åŠ åˆ°å®¹å™¨ä¸­
        container.appendChild(toast);

        if (darkMode) {
            toast.classList.toggle('dark-mode');// è®¾ç½®æ·±è‰²æ¨¡å¼
        }

        setTimeout(function () {// æ˜¾ç¤ºToast
            toast.classList.add('show');
        }, 30);

        setTimeout(function () {// éšè—Toast
            toast.classList.add('hide');
            setTimeout(function () {
                container.removeChild(toast);
            }, 300);
        }, 1000);
    }
    //filesize è½¬æ¢å¸¦å•ä½
    function getReadableFileSizeString(fileSizeInBytes) {
        var i = -1;
        var byteUnits = [' kB', ' MB', ' GB', ' TB', 'PB', 'EB', 'ZB', 'YB'];
        do {
            fileSizeInBytes /= 1024;
            i++;
        } while (fileSizeInBytes > 1024);

        return Math.max(fileSizeInBytes, 0.1).toFixed(1) + byteUnits[i];
    }
    //getIconbyExtension
    function getIconbyExtension(file) {
        let extension = file.split('.')[1];
        switch (extension) {
            case 'png':
                return 'ğŸ–¼ï¸';
            case 'jpg':
                return 'ğŸ–¼ï¸';
            case 'gif':
                return 'ğŸ–¼ï¸';
            case 'zip':
                return 'ğŸ“¦';
            case 'txt':
                return 'ğŸ“œ';
            case 'exe':
                return 'ğŸ’½';
            default:
                return 'ğŸ§©';
        }
    }
    //turn long name into short name
    function shortName(filename) {
        if (filename.length <= 30)
            return filename;
        else {
            let extension = '';
            if (filename.split('.')[1] != null)
                extension = filename.split('.')[1];
            let a = filename.slice(0, 25) + '...';
            let b = a + ' .' + extension
            return b;
        }

    }
    //checkcmd -- commands for special purpose
    function checkcmd() {
        let cmd = document.getElementById('filelist_info').value;
        switch (cmd) {
            case 'da'://deleteall
                console.log('da');
                let x = confirm('sure delete all files?');
                if (x == true)
                    deleteAllFile();
                refreshFilelist(false);
                break;
            default:
                refreshFilelist(true);
        }
    }
</script>

<script src="axios.js"></script>
<script>//api
    //è·å–å½“å‰url
    var url = window.location.href;
    //æå–urlçš„ip
    var ip = url.split('/')[2].split('/')[0].split(':')[0];
    console.log("ä» url è·å–æœåŠ¡å™¨ ip: " + ip)
    apiserver = ip
    port = '3000' //ç«¯å£å·é»˜è®¤3000

    fetch('apiport.txt')
        .then(response => {
            if (response.ok) {
                return response.text();
            } else {
                throw new Error('apiport.txt not found');
            }
        })
        .then(myport => {
            port = `${myport}`;
            console.log('apiport.txt -- use api port:' + port);
            axios.defaults.baseURL = `http://${ip}:${port}/box1`;
        })
        .catch(error => {
            console.log('apiport.txt notfound -- use defult port: 3000 ;');
            axios.defaults.baseURL = `http://${ip}:${port}/box1`;
        });


    // upload
    function uploadFile() {
        if (document.querySelector('#the_file').files[0] == null) {
            showToast('âŒ Empty file', false);
            return;
        }

        let config = {
            url: '/upload',
            method: 'Post',
            data: {
                the_file: document.querySelector('#the_file').files[0]
            },
            headers: {
                'Content-Type': 'multipart/form-data'
            }
        }
        axios(config)
            .then((response) => {
                console.log(response);
                showToast('ğŸ“¤ Upload success', false);
            })
            .catch((error) => {
                console.log(error);
                if (toast)
                    showToast('âŒ Upload failed', false);
            })
    }
    // upload - choosing by clicking input text
    function choosefile() {
        console.log('choosing');
        document.getElementById("the_file").click();
    }
    // upload - get file size and name
    let fileinput = document.querySelector('#the_file');
    fileinput.addEventListener('change', (e) => {
        let file_lable_input = document.querySelector('#file_lable');
        file_lable_input.value = '[' + getReadableFileSizeString(fileinput.files[0].size) + '] ' + fileinput.files[0].name;
    })


    //function deleteFile
    function deleteFile(filename) {
        axios.get('/delete/' + filename)
            .then((response) => {
                showToast('ğŸ—‘ï¸ Delete success', false);
            })
            .catch((error) => {
                console.log(error);
                if (toast)
                    showToast('âŒ Delete failed', false);
            })
    }

    //function deleteFile
    function deleteAllFile() {
        axios.get('/deleteall/')
            .then((response) => {
                showToast('ğŸ—‘ï¸ Delete All Done', false);
            })
            .catch((error) => {
                console.log(error);
                if (toast)
                    showToast('âŒ Delete failed', false);
            })
    }
    //function downloadFile
    function downloadFile(filename) {
        axios.get('/download/' + filename, { responseType: 'blob' })
            .then((response) => { // å¤„ç†æˆåŠŸçš„å“åº”
                const url = window.URL.createObjectURL(new Blob([response.data])); // åˆ›å»ºä¸€ä¸ªä¸´æ—¶URL
                const link = document.createElement('a'); // åˆ›å»ºä¸€ä¸ªä¸‹è½½é“¾æ¥
                link.href = url; // è®¾ç½®é“¾æ¥çš„URL
                link.setAttribute('download', filename); // è®¾ç½®ä¸‹è½½çš„æ–‡ä»¶å
                document.body.appendChild(link); // å°†é“¾æ¥æ·»åŠ åˆ°é¡µé¢ä¸­
                link.click(); // æ¨¡æ‹Ÿç‚¹å‡»ä¸‹è½½
                link.remove(); // ç§»é™¤é“¾æ¥
                window.URL.revokeObjectURL(url); // é‡Šæ”¾ä¸´æ—¶URLèµ„æº
                showToast('ğŸ“¥ Download success', false); // æ˜¾ç¤ºä¸‹è½½æˆåŠŸçš„æç¤º
            })
            .catch((error) => { // å¤„ç†å¤±è´¥çš„å“åº”
                console.log(error);
                showToast('âŒ Download failed', false); // æ˜¾ç¤ºä¸‹è½½å¤±è´¥çš„æç¤º
            });
    }
</script>
<script>//refreash funcion 
    function refreshFilelist(toast = true) {
        axios.get('/filelist')
            .then((response) => {
                console.log(response);
                let filelist = document.querySelector('.filelist');
                filelist.innerHTML = '';
                for (let i = 0; i < response.data.length; i++) {
                    let file = document.createElement('div');
                    file.classList.add('file');

                    let filename = response.data[i]
                    file.innerHTML =
                        '<span class="file-icon">' +
                        getIconbyExtension(filename) +
                        '</span> <small class="file-name"> ' + shortName(filename) + '</small>' +
                        '<span class="file-actions">\
                            <button onclick="downloadFile(`'+ filename + '`);refreshFilelist(false);">ğŸ’¾</button>\
                            <button onclick="deleteFile(`'+ filename + '`);refreshFilelist(false);">ğŸ—‘ï¸</button>\
                            </span>';
                    filelist.appendChild(file);
                }
                if (toast)
                    showToast('ğŸ”° Reload success', false);
                //è®¡æ•°å™¨
                let filelistinfo = document.querySelector('#filelist_info');
                filelistinfo.value = response.data.length + '_files';
            })
            .catch((error) => {
                console.log(error);
                if (toast)
                    showToast('âŒ Reload failed', false);
            })
    }
</script>
<script>//onload
    refreshFilelist();
</script>

</html>